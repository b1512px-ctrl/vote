<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人活動平台 (整合版)</title>
    
    <script>
        // 忽略 Tailwind CDN 的警告
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) {
                    return; 
                }
                originalWarn.apply(console, args);
            };
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 html2canvas 用於匯出圖片 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .vote-card, .event-card, .lesson-card { transition: all 0.2s ease; }
        .vote-card:hover, .event-card:hover, .lesson-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        #welcome-modal { background-image: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        
        .toggle-checkbox:checked { right: 0; border-color: #4F46E5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4F46E5; }
        
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        /* 定課卡片匯出樣式 */
        #export-canvas-container { position: absolute; left: -9999px; top: -9999px; }
        .lesson-export-card { width: 600px; padding: 40px; background: white; font-family: 'Helvetica', 'Arial', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800 font-sans">

    <!-- 1. 登入畫面 -->
    <div id="welcome-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center relative transition-all duration-300">
            <div class="mb-6 text-gray-800"><i class="fa-solid fa-users-gear text-5xl"></i></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">身分驗證</h2>
            <p class="text-gray-500 mb-6 text-sm">請選擇您的登入身分</p>
            
            <div id="role-select-step" class="space-y-3">
                <button onclick="window.selectRole('admin')" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-shield-halved"></i> 管理員
                </button>
                <button onclick="window.selectRole('member')" class="w-full bg-gray-900 hover:bg-black text-white font-bold py-3 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-user-check"></i> 成員
                </button>
                <button onclick="window.selectRole('guest')" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-eye"></i> 訪客
                </button>
            </div>

            <div id="login-input-step" class="space-y-4 hidden">
                <div id="role-badge" class="inline-block px-3 py-1 rounded-full text-xs font-bold mb-2"></div>
                <input type="text" id="login-name-input" placeholder="請輸入暱稱" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-800 focus:outline-none text-center text-lg">
                <input type="password" id="login-pwd-input" placeholder="請輸入密碼" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-800 focus:outline-none text-center text-lg hidden">
                <div class="flex gap-2">
                    <button onclick="window.resetLogin()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg">返回</button>
                    <button id="login-submit-btn" class="flex-1 bg-blue-800 hover:bg-blue-900 text-white font-bold py-3 rounded-lg shadow-lg">進入</button>
                </div>
            </div>
            <p id="login-msg" class="mt-4 text-xs text-red-500 min-h-[1rem]"></p>
        </div>
    </div>

    <!-- 2. 主選單 -->
    <div id="main-menu-container" class="hidden min-h-screen flex flex-col">
        <header class="bg-gray-800 text-white shadow-lg p-4 flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-bars mr-2"></i>功能選單</h1>
            <div class="text-xs">
                <span id="menu-user-display"></span>
                <button id="menu-logout-btn" class="underline hover:text-white ml-2">登出</button>
            </div>
        </header>
        <main class="flex-1 p-6 max-w-4xl mx-auto w-full grid grid-cols-1 md:grid-cols-3 gap-6 content-center">
            <div onclick="window.switchApp('vote')" class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl cursor-pointer border-l-8 border-blue-500 transition-all group">
                <div class="text-blue-500 text-4xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-check-to-slot"></i></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">投票功能</h2>
                <p class="text-gray-500 text-sm">發起聚餐、活動日期投票，即時統計參加人數。</p>
            </div>
            <div onclick="window.switchApp('fine')" class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl cursor-pointer border-l-8 border-red-500 transition-all group">
                <div class="text-red-500 text-4xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-gavel"></i></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">罰款統計</h2>
                <p class="text-gray-500 text-sm">追蹤任務執行與罰款計算。</p>
            </div>
            <div onclick="window.switchApp('lesson')" class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl cursor-pointer border-l-8 border-teal-500 transition-all group">
                <div class="text-teal-500 text-4xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-book-open-reader"></i></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">每日定課</h2>
                <p class="text-gray-500 text-sm">紀錄每日感恩、觀心書與待辦。</p>
            </div>
        </main>
    </div>

    <!-- 3. 投票功能 -->
    <div id="vote-app-container" class="hidden min-h-screen pb-10">
        <header id="vote-header" class="bg-gray-800 text-white shadow-lg sticky top-0 z-10 transition-colors duration-300">
            <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-users"></i><span id="vote-header-title">活動大廳</span></h1>
                <button onclick="window.backToMenu()" class="text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors"><i class="fa-solid fa-house mr-1"></i>選單</button>
            </div>
        </header>
        <main class="max-w-4xl mx-auto px-4 py-6">
             <div id="permission-warning" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 hidden">
                <p class="font-bold"><i class="fa-solid fa-ban"></i> 權限不足</p>
                <p class="text-sm">操作被拒絕。請確認權限或 Firestore Rules。</p>
            </div>
             <div id="vote-dashboard-view">
                 <!-- 柱專用設定 -->
                 <div id="super-admin-settings" class="bg-white rounded-xl shadow-md p-4 mb-6 border border-indigo-200 hidden">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center"><i class="fa-solid fa-gears text-indigo-600 text-xl mr-3"></i><div><h3 class="font-bold text-gray-800">系統管理</h3><p class="text-xs text-gray-500">成員註冊開關</p></div></div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="reg-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                            <label for="reg-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <p id="reg-status-text" class="text-right text-xs mt-1 text-gray-500">讀取中...</p>
                </div>
                <div id="create-event-section" class="bg-white rounded-xl shadow-md p-6 mb-8 border-l-4 hidden">
                    <h2 class="text-lg font-semibold mb-4 text-gray-700">發起新活動</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <input type="text" id="new-event-title" placeholder="活動主題..." class="flex-1 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                        <button id="create-event-btn" class="bg-gray-800 hover:bg-gray-900 text-white px-6 py-2 rounded-lg font-bold whitespace-nowrap">建立</button>
                    </div>
                </div>
                <div class="mb-4"><h2 class="text-xl font-bold text-gray-800">活動列表</h2></div>
                <div id="events-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div id="vote-detail-view" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="current-vote-title" class="text-2xl font-bold text-gray-800"></h2>
                    <button onclick="window.loadVoteDashboard()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-sm font-bold transition-colors flex items-center shadow-sm"><i class="fa-solid fa-arrow-left mr-1"></i> 回列表</button>
                </div>
                <div id="create-vote-section" class="bg-white rounded-xl shadow-md p-4 mb-6 border hidden">
                    <div class="flex items-center mb-2 text-gray-800 text-sm font-bold" id="cv-header-text"><i class="fa-solid fa-pen-to-square mr-1"></i> 新增選項</div>
                    <div class="flex flex-col md:flex-row gap-2">
                        <div class="relative flex-1 group cursor-pointer" onclick="try{document.getElementById('new-vote-date').showPicker()}catch(e){document.getElementById('new-vote-date').focus()}">
                            <input type="date" id="new-vote-date" class="absolute inset-0 w-full h-full opacity-0 pointer-events-none" tabindex="-1">
                            <div id="date-display-box" class="w-full border rounded-lg px-3 py-2 bg-white flex justify-between items-center h-[42px] transition-colors border-gray-300">
                                <span id="date-display-text" class="text-gray-400 text-sm select-none">年/月/日</span><i class="fa-regular fa-calendar text-gray-500"></i>
                            </div>
                        </div>
                        <input type="text" id="new-vote-note" placeholder="備註 (例: 午餐)" class="flex-1 border rounded-lg px-3 py-2 outline-none focus:ring-1 focus:ring-blue-500">
                        <button id="add-vote-btn" class="bg-gray-800 text-white px-4 py-2 rounded-lg font-bold">新增</button>
                    </div>
                </div>
                <div id="guest-hint" class="bg-gray-100 text-gray-600 p-3 rounded-lg mb-6 text-center text-sm border hidden"><i class="fa-solid fa-eye mr-1"></i> 訪客模式 (唯讀)</div>
                <div id="vote-list" class="space-y-3"></div>
            </div>
        </main>
    </div>

    <!-- 4. 罰款統計功能 -->
    <div id="fine-app-container" class="hidden min-h-screen pb-10">
        <header class="bg-red-800 text-white shadow-lg sticky top-0 z-10">
            <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-gavel"></i>罰款統計</h1>
                <button onclick="window.backToMenu()" class="text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors"><i class="fa-solid fa-house mr-1"></i>選單</button>
            </div>
        </header>
        <main class="max-w-5xl mx-auto px-4 py-6">
            <div id="fine-dashboard-view">
                <div id="create-fine-event-card" class="bg-white rounded-xl shadow-md mb-8 border-l-4 border-red-500 hidden overflow-hidden transition-all">
                    <div class="p-6 flex justify-between items-center cursor-pointer hover:bg-gray-50 select-none" onclick="window.toggleFineForm()">
                        <h2 class="text-lg font-semibold text-gray-700 m-0">建立新活動任務</h2>
                        <i id="fine-form-arrow" class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300"></i>
                    </div>
                    <div id="fine-form-content" class="px-6 pb-6 hidden border-t border-gray-100 pt-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="fine-title" placeholder="活動名稱" class="border rounded px-3 py-2 w-full">
                            <div class="flex gap-2">
                                <div class="relative w-1/2 group cursor-pointer" onclick="try{document.getElementById('fine-start').showPicker()}catch(e){document.getElementById('fine-start').focus()}">
                                    <input type="date" id="fine-start" class="absolute inset-0 w-full h-full opacity-0 pointer-events-none" tabindex="-1">
                                    <div class="w-full border rounded px-3 py-2 bg-white flex justify-between items-center h-[42px] transition-colors border-gray-200">
                                        <span id="fine-start-display-text" class="text-gray-400 text-sm select-none">開始日期</span><i class="fa-regular fa-calendar text-gray-400"></i>
                                    </div>
                                </div>
                                <div class="relative w-1/2 group cursor-pointer" onclick="try{document.getElementById('fine-end').showPicker()}catch(e){document.getElementById('fine-end').focus()}">
                                    <input type="date" id="fine-end" class="absolute inset-0 w-full h-full opacity-0 pointer-events-none" tabindex="-1">
                                    <div class="w-full border rounded px-3 py-2 bg-white flex justify-between items-center h-[42px] transition-colors border-gray-200">
                                        <span id="fine-end-display-text" class="text-gray-400 text-sm select-none">結束日期</span><i class="fa-regular fa-calendar text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4 p-3 bg-gray-50 rounded border">
                            <h3 class="text-sm font-bold text-gray-600 mb-2">任務與罰金設定</h3>
                            <div id="task-inputs" class="space-y-3">
                                <div class="flex flex-col sm:flex-row gap-2 task-row border-b pb-3 sm:border-0 sm:pb-0 last:border-0 mb-2 sm:mb-0">
                                    <input type="text" placeholder="任務名稱" class="border rounded px-3 py-1 w-full sm:flex-1 task-name">
                                    <div class="flex gap-2">
                                        <input type="number" placeholder="罰款$" class="border rounded px-3 py-1 flex-1 sm:w-24 task-fine">
                                    </div>
                                </div>
                            </div>
                            <button onclick="window.addTaskRow()" class="text-sm text-blue-600 mt-3 hover:underline flex items-center"><i class="fa-solid fa-plus mr-1"></i> 增加任務</button>
                        </div>
                        <div class="mb-4">
                            <h3 class="text-sm font-bold text-gray-600 mb-2">選擇參加人員 (多選)</h3>
                            <div id="user-select-list" class="grid grid-cols-2 md:grid-cols-4 gap-2 max-h-32 overflow-y-auto border p-2 rounded bg-white"><p class="text-xs text-gray-400 col-span-full">載入中...</p></div>
                            <p class="text-xs text-gray-400 mt-1">* 只有登入過的使用者會出現在此列表</p>
                            <div class="mt-2 p-2 bg-gray-50 rounded border border-gray-200">
                                <p class="text-xs font-bold text-gray-600 mb-1">找不到人？手動補登</p>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <input type="text" id="manual-user-name" placeholder="姓名" class="border rounded px-2 py-1 text-sm w-full sm:w-1/3">
                                    <div class="flex gap-2 w-full sm:flex-1">
                                        <input type="text" id="manual-user-uid" placeholder="UID" class="border rounded px-2 py-1 text-sm flex-1">
                                        <button onclick="window.manualAddUser()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 whitespace-nowrap">加入</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button onclick="window.createFineEvent()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold w-full">建立活動</button>
                    </div>
                </div>
                <div class="mb-4"><h2 class="text-xl font-bold text-gray-800">進行中的任務</h2></div>
                <div id="fine-events-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div id="fine-detail-view" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <div><h2 id="fd-title" class="text-2xl font-bold text-gray-800"></h2><p id="fd-dates" class="text-sm text-gray-500"></p></div>
                    <button onclick="window.loadFineDashboard()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-sm font-bold transition-colors flex items-center shadow-sm"><i class="fa-solid fa-arrow-left mr-1"></i> 回列表</button>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 mb-8 border border-green-100">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center"><i class="fa-solid fa-calendar-check text-green-600 mr-2"></i> 今日打卡 (<span id="today-date-str"></span>)</h3>
                    <div id="daily-check-area" class="space-y-3"><p class="text-gray-400">載入中...</p></div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 overflow-hidden">
                    <h3 class="text-lg font-bold text-gray-700 mb-4"><i class="fa-solid fa-table mr-2"></i>罰款統計表</h3>
                    <div class="table-responsive">
                        <table class="w-full text-sm text-left border-collapse"><thead class="bg-gray-100 text-gray-600 uppercase"><tr id="stats-header"></tr></thead><tbody id="stats-body" class="divide-y divide-gray-200"></tbody></table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 5. 每日定課功能 (Lesson App) -->
    <div id="lesson-app-container" class="hidden min-h-screen pb-10">
        <header class="bg-teal-700 text-white shadow-lg sticky top-0 z-10">
            <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-book-open-reader"></i>每日定課</h1>
                <button onclick="window.backToMenu()" class="text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors"><i class="fa-solid fa-house mr-1"></i>選單</button>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-6">
            <!-- 頂部功能列 -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-6 flex flex-col md:flex-row gap-4 items-center justify-between border-l-4 border-teal-500">
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <label class="text-sm font-bold text-gray-600">查看人員:</label>
                    <select id="lesson-user-select" class="border rounded px-3 py-2 flex-1 md:flex-none text-sm bg-gray-50 focus:ring-2 focus:ring-teal-500 outline-none">
                        <!-- JS Populate -->
                    </select>
                </div>
                <div class="flex items-center gap-2 w-full md:w-auto justify-end">
                     <button id="lesson-add-btn" onclick="window.openLessonForm()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow transition-colors flex items-center hidden">
                        <i class="fa-solid fa-plus mr-1"></i> 新增/編輯
                     </button>
                </div>
            </div>
            
            <!-- 視圖1: 列表模式 -->
            <div id="lesson-list-view">
                <div class="bg-gray-50 rounded-xl border border-gray-200 p-6">
                    <h3 class="text-lg font-bold text-gray-600 mb-4 flex items-center justify-between">
                        <span><i class="fa-solid fa-list-ul mr-2"></i>定課紀錄</span>
                        <button onclick="window.exportSelectedLessons()" class="bg-gray-600 hover:bg-gray-700 text-white text-xs px-3 py-1.5 rounded transition-colors"><i class="fa-solid fa-download mr-1"></i>匯出選取</button>
                    </h3>
                    
                    <div class="flex items-center gap-2 mb-2 ml-1">
                        <input type="checkbox" id="check-all-lessons" onchange="window.toggleAllLessons(this.checked)" class="form-checkbox text-teal-600 rounded">
                        <label for="check-all-lessons" class="text-sm text-gray-500 cursor-pointer select-none">全選本頁</label>
                    </div>

                    <div id="lesson-history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-gray-400 text-sm col-span-full">載入中...</p>
                    </div>
                    
                    <div class="flex justify-center mt-6 gap-2" id="lesson-pagination"></div>
                </div>
            </div>

            <!-- 視圖2: 表單模式 -->
            <div id="lesson-form-view" class="hidden">
                <div class="mb-4">
                    <button onclick="window.closeLessonForm()" class="text-teal-600 hover:text-teal-800 font-bold flex items-center">
                        <i class="fa-solid fa-arrow-left mr-1"></i> 返回列表
                    </button>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8 relative">
                    <div id="lesson-overlay" class="absolute inset-0 bg-gray-100/50 z-10 hidden flex items-center justify-center rounded-xl cursor-not-allowed"></div>
                    
                    <!-- 日期選擇區塊 -->
                    <div class="text-center mb-6 border-b pb-4 flex justify-center">
                        <div class="relative w-48 group cursor-pointer" onclick="try{document.getElementById('lesson-form-date').showPicker()}catch(e){document.getElementById('lesson-form-date').focus()}">
                            <input type="date" id="lesson-form-date" class="absolute inset-0 w-full h-full opacity-0 pointer-events-none" tabindex="-1">
                            <div class="w-full border rounded px-3 py-2 bg-white flex justify-between items-center h-[38px] transition-colors border-gray-300 hover:border-teal-500">
                                <span id="lesson-form-date-display" class="text-gray-800 text-lg font-bold select-none">YYYY/MM/DD</span>
                                <i class="fa-regular fa-calendar text-teal-500"></i>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-teal-700 mb-3 border-b pb-2">每日五感恩</h3>
                        <div class="space-y-2" id="gratitude-inputs">
                            <input type="text" class="w-full border rounded px-3 py-2 text-sm focus:ring-1 focus:ring-teal-500 outline-none l-input" placeholder="1. ...">
                            <input type="text" class="w-full border rounded px-3 py-2 text-sm focus:ring-1 focus:ring-teal-500 outline-none l-input" placeholder="2. ...">
                            <input type="text" class="w-full border rounded px-3 py-2 text-sm focus:ring-1 focus:ring-teal-500 outline-none l-input" placeholder="3. ...">
                            <input type="text" class="w-full border rounded px-3 py-2 text-sm focus:ring-1 focus:ring-teal-500 outline-none l-input" placeholder="4. ...">
                            <input type="text" class="w-full border rounded px-3 py-2 text-sm focus:ring-1 focus:ring-teal-500 outline-none l-input" placeholder="5. ...">
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-teal-700 mb-3 border-b pb-2">關心書</h3>
                        <textarea id="carebook-input" class="w-full border rounded px-3 py-2 text-sm h-24 focus:ring-1 focus:ring-teal-500 outline-none l-input" placeholder="寫下今天的觀察與關心..."></textarea>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-teal-700 mb-3 border-b pb-2">To-do</h3>
                        <textarea id="todo-input" class="w-full border rounded px-3 py-2 text-sm h-24 focus:ring-1 focus:ring-teal-500 outline-none l-input" placeholder="待辦事項..."></textarea>
                    </div>

                    <div class="flex justify-end gap-3">
                        <p id="lesson-msg" class="text-sm text-green-600 self-center font-bold mr-2"></p>
                        <button onclick="window.saveLesson()" id="save-lesson-btn" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded-lg font-bold shadow transition-colors">儲存</button>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 隱藏的匯出容器 -->
        <div id="export-canvas-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, onSnapshot, serverTimestamp, query, orderBy, where, limit, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        try { if (typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config); } catch (e) {}
        if (!firebaseConfig) {
            firebaseConfig = {
                apiKey: "AIzaSyDQiHjNozV07Q8y6XtqGSAMcCnOEaGhPqM",
  				authDomain: "vote-7e8d0.firebaseapp.com",
  				projectId: "vote-7e8d0",
  				storageBucket: "vote-7e8d0.firebasestorage.app",
  				messagingSenderId: "218847236466",
  				appId: "1:218847236466:web:d1904b9ec032ac35a7cdeb",
  				measurementId: "G-HKJ9QSFB5L"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_LIST = ['ELLY LIN', 'Ling', 'Luna', '柱'];
        const SUPER_ADMIN = '柱';
        
        let currentUser = null;
        let isAdmin = false;
        let isMember = false;
        let selectedRole = null; 
        let displayName = '';

        function getColRef(colName) {
            const appIdStr = (typeof __app_id !== 'undefined') ? __app_id : 'default';
            if (typeof __app_id !== 'undefined') {
                return collection(db, 'artifacts', appIdStr, 'public', 'data', colName);
            }
            return collection(db, colName);
        }
        function getDocRef(colName, docId) {
            const appIdStr = (typeof __app_id !== 'undefined') ? __app_id : 'default';
            if (typeof __app_id !== 'undefined') {
                return doc(db, 'artifacts', appIdStr, 'public', 'data', colName, docId);
            }
            return doc(db, colName, docId);
        }
        
        function getLocalTodayStr() {
            const now = new Date();
            return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                checkUserPermissions(user);
                
                displayName = sessionStorage.getItem('display_name');
                if (!displayName && user.email) displayName = user.email.split('@')[0].replace('_', ' ').toUpperCase();
                if (!displayName) displayName = 'Guest';

                if (isAdmin || isMember) {
                    await setDoc(getDocRef('users', user.uid), {
                        name: displayName,
                        role: isAdmin ? 'Admin' : 'Member',
                        lastLogin: serverTimestamp()
                    }, { merge: true });
                }

                showMenuUI();
            } else {
                showLoginUI();
            }
        });
        
        // Date Pickers Listeners
        ['new-vote-date', 'fine-start', 'fine-end', 'lesson-form-date'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('change', function() {
                    const suffix = id === 'lesson-form-date' ? '-display' : (id === 'new-vote-date' ? '-display-text' : '-display-text');
                    const displayId = id.replace('new-vote-date', 'date').replace('fine-start', 'fine-start').replace('fine-end', 'fine-end') + suffix;
                    const display = document.getElementById(displayId);
                    
                    let targetDisplay = display;
                    if(id === 'new-vote-date') targetDisplay = document.getElementById('date-display-text');

                    if (this.value) {
                        const formattedDate = this.value.replace(/-/g, '/');
                        targetDisplay.textContent = formattedDate;
                        targetDisplay.classList.remove('text-gray-400');
                        targetDisplay.classList.add('text-gray-800');
                        if(id === 'lesson-form-date') {
                             lessonSelectedDate = this.value;
                             window.loadLessonData();
                        }
                    } else {
                         if(id === 'lesson-form-date') targetDisplay.textContent = getLocalTodayStr().replace(/-/g, '/');
                         else if(id === 'new-vote-date') targetDisplay.textContent = '年/月/日';
                         else targetDisplay.textContent = id === 'fine-start' ? '開始日期' : '結束日期';
                         targetDisplay.classList.add('text-gray-400');
                         targetDisplay.classList.remove('text-gray-800');
                    }
                });
            }
        });

        function checkUserPermissions(user) {
            const email = user.email || '';
            isAdmin = email.endsWith('@admin.com');
            isMember = email.endsWith('@member.com');
        }

        window.selectRole = (role) => {
            selectedRole = role;
            document.getElementById('role-select-step').classList.add('hidden');
            document.getElementById('login-input-step').classList.remove('hidden');
            const badge = document.getElementById('role-badge');
            const pwdInput = document.getElementById('login-pwd-input');
            const nameInput = document.getElementById('login-name-input');
            nameInput.value = ''; pwdInput.value = '';
            
            if (role === 'admin') {
                badge.textContent = '管理員登入'; badge.className = 'inline-block px-3 py-1 rounded-full text-xs font-bold mb-2 bg-blue-100 text-blue-800';
                pwdInput.classList.remove('hidden');
            } else if (role === 'member') {
                badge.textContent = '成員登入'; badge.className = 'inline-block px-3 py-1 rounded-full text-xs font-bold mb-2 bg-gray-200 text-gray-900';
                pwdInput.classList.remove('hidden');
            } else {
                badge.textContent = '訪客預覽'; badge.className = 'inline-block px-3 py-1 rounded-full text-xs font-bold mb-2 bg-gray-200 text-gray-500';
                pwdInput.classList.add('hidden');
            }
        };

        window.resetLogin = () => {
            document.getElementById('login-input-step').classList.add('hidden');
            document.getElementById('role-select-step').classList.remove('hidden');
            selectedRole = null;
        };

        document.getElementById('login-submit-btn').onclick = () => {
            const name = document.getElementById('login-name-input').value.trim();
            if (!name) return;
            if (selectedRole === 'guest') {
                performGuestLogin(name);
            } else {
                const pwd = document.getElementById('login-pwd-input').value;
                if (!pwd) return alert('請輸入密碼');
                if (selectedRole === 'admin') {
                    const matched = ADMIN_LIST.find(a => a.toLowerCase() === name.toLowerCase());
                    if (!matched) return alert('此名稱非管理員');
                    performAuthLogin(matched, pwd, 'admin.com');
                } else {
                    performAuthLogin(name, pwd, 'member.com');
                }
            }
        };

        async function performGuestLogin(name) {
            try {
                sessionStorage.setItem('display_name', name);
                await signInAnonymously(auth);
            } catch (e) { alert(e.message); }
        }

        async function performAuthLogin(name, pwd, domain) {
            const email = name.toLowerCase().replace(/\s+/g, '_') + '@' + domain;
            try {
                await signInWithEmailAndPassword(auth, email, pwd);
                sessionStorage.setItem('display_name', name);
            } catch (e) {
                if (e.code === 'auth/user-not-found' || e.code === 'auth/invalid-credential') {
                    if (domain === 'member.com') {
                        try {
                            const snap = await getDoc(getDocRef('events', 'system_settings'));
                            if (snap.exists() && snap.data().memberRegistrationOpen === false) {
                                return alert('目前暫停開放新成員註冊');
                            }
                        } catch(err){}
                    }
                    try {
                        await createUserWithEmailAndPassword(auth, email, pwd);
                        sessionStorage.setItem('display_name', name);
                    } catch (regE) { alert('註冊/登入失敗: ' + regE.message); }
                } else { alert('登入失敗: ' + e.message); }
            }
        }

        const menuLogoutBtn = document.getElementById('menu-logout-btn');
        if (menuLogoutBtn) {
            menuLogoutBtn.onclick = () => {
                if(confirm('登出?')) {
                    sessionStorage.removeItem('display_name');
                    signOut(auth);
                }
            };
        }

        function showLoginUI() {
            document.getElementById('welcome-modal').classList.remove('hidden');
            document.getElementById('main-menu-container').classList.add('hidden');
            document.getElementById('vote-app-container').classList.add('hidden');
            document.getElementById('fine-app-container').classList.add('hidden');
            document.getElementById('lesson-app-container').classList.add('hidden');
            window.resetLogin();
        }

        function showMenuUI() {
            document.getElementById('welcome-modal').classList.add('hidden');
            document.getElementById('main-menu-container').classList.remove('hidden');
            document.getElementById('vote-app-container').classList.add('hidden');
            document.getElementById('fine-app-container').classList.add('hidden');
            document.getElementById('lesson-app-container').classList.add('hidden');
            
            const roleStr = isAdmin ? '管理員' : (isMember ? '成員' : '訪客');
            document.getElementById('menu-user-display').textContent = `${roleStr}: ${displayName}`;
        }

        window.switchApp = (appName) => {
            if (appName === 'vote') initVoteApp();
            else if (appName === 'fine') {
                if (!isAdmin && !isMember) return alert("權限不足: 訪客無法進入罰款統計");
                initFineApp();
            } else if (appName === 'lesson') {
                if (!isAdmin && !isMember) return alert("權限不足: 訪客無法進入每日定課");
                initLessonApp();
            }
        };

        window.backToMenu = () => {
            if (unsubEvents) unsubEvents();
            if (unsubVotes) unsubVotes();
            if (unsubFineEvents) unsubFineEvents();
            if (unsubUserList) unsubUserList();
            showMenuUI();
        };

        // --- VOTE APP LOGIC ---
        let unsubEvents, unsubVotes, currentVoteEventId;
        function initVoteApp() {
            document.getElementById('main-menu-container').classList.add('hidden');
            document.getElementById('vote-app-container').classList.remove('hidden');
            
            const header = document.getElementById('vote-header');
            const createSec = document.getElementById('create-event-section');
            const createVoteSec = document.getElementById('create-vote-section');
            const guestHint = document.getElementById('guest-hint');
            const createBtn = document.getElementById('create-event-btn');
            const addVoteBtn = document.getElementById('add-vote-btn');
            const cvHeader = document.getElementById('cv-header-text');
            const settings = document.getElementById('super-admin-settings');
            const dateDisplayBox = document.getElementById('date-display-box');

            if (isAdmin) {
                header.className = "bg-blue-700 text-white shadow-lg sticky top-0 z-10 transition-colors duration-300";
                createBtn.className = "bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold whitespace-nowrap transition-colors";
                addVoteBtn.className = "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold whitespace-nowrap transition-colors";
                createSec.classList.remove('hidden', 'border-gray-800'); createSec.classList.add('border-blue-500');
                createVoteSec.classList.remove('hidden', 'border-gray-800'); createVoteSec.classList.add('border-blue-200');
                if(cvHeader) cvHeader.className = "flex items-center mb-2 text-blue-800 text-sm font-bold";
                if(dateDisplayBox) dateDisplayBox.className = "w-full border rounded-lg px-3 py-2 bg-white flex justify-between items-center h-[42px] transition-colors border-gray-300";
                guestHint.classList.add('hidden');
                settings.classList[displayName === SUPER_ADMIN ? 'remove' : 'add']('hidden');
                if(displayName === SUPER_ADMIN) initSettingsToggle();

            } else if (isMember) {
                header.className = "bg-gray-900 text-white shadow-lg sticky top-0 z-10 transition-colors duration-300";
                createBtn.className = "bg-gray-800 hover:bg-black text-white px-6 py-2 rounded-lg font-bold whitespace-nowrap transition-colors";
                addVoteBtn.className = "bg-gray-800 hover:bg-black text-white px-4 py-2 rounded-lg font-bold whitespace-nowrap transition-colors";
                createSec.classList.remove('hidden', 'border-blue-500'); createSec.classList.add('border-gray-800');
                createVoteSec.classList.remove('hidden', 'border-blue-200'); createVoteSec.classList.add('border-gray-800');
                if(cvHeader) cvHeader.className = "flex items-center mb-2 text-gray-900 text-sm font-bold";
                if(dateDisplayBox) dateDisplayBox.className = "w-full border rounded-lg px-3 py-2 bg-white flex justify-between items-center h-[42px] transition-colors border-gray-300";
                guestHint.classList.add('hidden');
                settings.classList.add('hidden');
            } else {
                header.className = "bg-gray-600 text-white shadow-lg sticky top-0 z-10 transition-colors duration-300";
                createSec.classList.add('hidden');
                createVoteSec.classList.add('hidden');
                guestHint.classList.remove('hidden');
                settings.classList.add('hidden');
            }
            window.loadVoteDashboard();
        }
        
        async function initSettingsToggle() {
            const status = document.getElementById('reg-status-text');
            const toggle = document.getElementById('reg-toggle');
            status.textContent = "讀取中...";
            try {
                const snap = await getDoc(getDocRef('events', 'system_settings'));
                let open = true;
                if (snap.exists()) open = snap.data().memberRegistrationOpen !== false;
                toggle.checked = open;
                status.textContent = open ? "成員註冊：已開放" : "已關閉";
                status.className = open ? "text-right text-xs mt-1 text-green-600 font-bold" : "text-right text-xs mt-1 text-red-500 font-bold";
                toggle.onchange = async () => {
                    const newState = toggle.checked;
                    status.textContent = newState ? "成員註冊：已開放" : "已關閉";
                    status.className = newState ? "text-right text-xs mt-1 text-green-600 font-bold" : "text-right text-xs mt-1 text-red-500 font-bold";
                    await setDoc(getDocRef('events', 'system_settings'), { memberRegistrationOpen: newState }, { merge: true });
                };
            } catch(e) { console.error(e); }
        }

        window.loadVoteDashboard = function() {
            document.getElementById('vote-dashboard-view').classList.remove('hidden');
            document.getElementById('vote-detail-view').classList.add('hidden');
            if(unsubVotes) unsubVotes();
            const q = query(getColRef('events'), orderBy('createdAt', 'desc'), limit(20));
            unsubEvents = onSnapshot(q, (snap) => {
                const list = document.getElementById('events-list');
                list.innerHTML = '';
                snap.forEach(doc => {
                    if (doc.id === 'system_settings') return;
                    const d = doc.data();
                    const date = d.createdAt ? new Date(d.createdAt.toDate()).toLocaleDateString() : '';
                    const delBtn = isAdmin ? `<button onclick="window.delEvent('${doc.id}', event)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-2"><i class="fa-solid fa-trash"></i></button>` : '';
                    list.innerHTML += `<div onclick="loadVoteDetail('${doc.id}', '${d.title}')" class="bg-white p-4 rounded-xl shadow hover:bg-gray-50 relative border cursor-pointer"><h3 class="font-bold text-lg">${d.title}</h3><p class="text-xs text-gray-500">發起: ${d.creator} | ${date}</p>${delBtn}</div>`;
                });
            });
        }

        window.loadVoteDetail = (id, title) => {
            currentVoteEventId = id;
            document.getElementById('vote-dashboard-view').classList.add('hidden');
            document.getElementById('vote-detail-view').classList.remove('hidden');
            document.getElementById('current-vote-title').textContent = title;
            document.getElementById('vote-list').innerHTML = '<div class="loader mx-auto"></div>';

            const q = query(getColRef('votes'), where('eventId', '==', id));
            unsubVotes = onSnapshot(q, (snap) => {
                const list = document.getElementById('vote-list');
                list.innerHTML = '';
                const votes = [];
                snap.forEach(d => votes.push({id: d.id, ...d.data()}));
                votes.sort((a,b) => (b.voters?.length||0) - (a.voters?.length||0));
                const max = votes.length ? (votes[0].voters?.length || 0) : 0;
                votes.forEach((v, idx) => {
                    const count = v.voters?.length || 0;
                    const percent = max > 0 ? (count/max)*100 : 0;
                    const hasVoted = v.voters && v.voters.includes(currentUser.uid);
                    const isWinner = idx === 0 && count > 0;
                    let border = hasVoted ? 'border-l-4 border-blue-500 bg-blue-50' : 'bg-white';
                    let bar = 'bg-blue-200';
                    let trophy = '';
                    if (isWinner) {
                        border = hasVoted ? 'border-l-4 border-yellow-500 bg-yellow-50' : 'border-l-4 border-yellow-400 bg-yellow-50';
                        bar = 'bg-yellow-200';
                        trophy = '<i class="fa-solid fa-trophy text-yellow-500 mr-2"></i>';
                    }
                    const delBtn = isAdmin ? `<button onclick="window.delVoteItem('${v.id}', event)" class="ml-2 text-red-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>` : '';
                    const check = hasVoted ? '<i class="fa-solid fa-check-circle text-2xl text-blue-600"></i>' : '';
                    const canVote = isAdmin || isMember;
                    list.innerHTML += `<div onclick="${canVote ? `window.doVote('${v.id}', ${hasVoted})` : ''}" class="relative p-4 rounded-lg shadow-sm border ${border} ${canVote?'cursor-pointer':'cursor-default'} overflow-hidden"><div class="absolute top-0 left-0 bottom-0 ${bar} opacity-20 pointer-events-none" style="width:${percent}%"></div><div class="relative flex justify-between items-center z-10"><div class="font-bold flex items-center">${trophy} ${v.date} <span class="text-sm font-normal text-gray-500 ml-2">${v.note||''}</span> <span class="text-xs text-gray-500 ml-1">(${count}人)</span></div><div class="flex items-center">${check}${delBtn}</div></div></div>`;
                });
            });
        };

        // [Vote Actions]
        document.getElementById('create-event-btn').onclick = async () => {
            const t = document.getElementById('new-event-title').value;
            if(!t) return;
            await addDoc(getColRef('events'), {title: t, creator: displayName, createdAt: serverTimestamp()});
            document.getElementById('new-event-title').value = '';
            alert('活動已建立');
        };
        document.getElementById('add-vote-btn').onclick = async () => {
            const d = document.getElementById('new-vote-date').value;
            const n = document.getElementById('new-vote-note').value;
            if(!d) return;
            await addDoc(getColRef('votes'), {eventId: currentVoteEventId, date: d, note: n, voters: []});
            document.getElementById('new-vote-date').value = '';
            document.getElementById('new-vote-note').value = '';
            document.getElementById('date-display-text').textContent = '年/月/日';
            // fix reset color
             document.getElementById('date-display-text').classList.add('text-gray-400');
             document.getElementById('date-display-text').classList.remove('text-gray-800');
        };
        window.doVote = async (id, has) => {
            const ref = getDocRef('votes', id);
            if(has) await updateDoc(ref, {voters: arrayRemove(currentUser.uid)});
            else await updateDoc(ref, {voters: arrayUnion(currentUser.uid)});
        };
        window.delEvent = async (id, e) => {
            e.stopPropagation(); if(confirm('刪除活動?')) await deleteDoc(getDocRef('events', id));
        };
        window.delVoteItem = async (id, e) => {
            e.stopPropagation(); if(confirm('刪除選項?')) await deleteDoc(getDocRef('votes', id));
        };

        // ============================
        //  FINE APP LOGIC
        // ============================
        let unsubFineEvents, unsubFineRecords, unsubUserList, currentFineEvent;
        function initFineApp() {
            document.getElementById('main-menu-container').classList.add('hidden');
            document.getElementById('fine-app-container').classList.remove('hidden');
            const createCard = document.getElementById('create-fine-event-card');
            if (isAdmin) {
                createCard.classList.remove('hidden');
                loadUserListForFine();
            } else createCard.classList.add('hidden');
            window.loadFineDashboard();
        }
        async function loadUserListForFine() {
            const list = document.getElementById('user-select-list');
            list.innerHTML = '讀取中...';
            try {
                const snap = await getDocs(getColRef('users'));
                list.innerHTML = '';
                snap.forEach(doc => {
                    const u = doc.data();
                    list.innerHTML += `<label class="flex items-center space-x-2 text-sm p-1 hover:bg-gray-50 rounded cursor-pointer"><input type="checkbox" value="${doc.id}" class="fine-user-check form-checkbox text-red-600 rounded"><span>${u.name}</span></label>`;
                });
            } catch (e) { list.innerHTML = '讀取失敗'; }
        }
        window.manualAddUser = async () => {
            const name = document.getElementById('manual-user-name').value.trim();
            let uid = document.getElementById('manual-user-uid').value.trim();
            if(!name) return alert('請輸入姓名');
            if(!uid) uid = 'manual_' + Date.now();
            try {
                await setDoc(getDocRef('users', uid), { name, role: 'Manual', createdAt: serverTimestamp() }, { merge: true });
                document.getElementById('manual-user-name').value = '';
                document.getElementById('manual-user-uid').value = '';
                alert('已加入');
            } catch(e) { alert('加入失敗: ' + e.message); }
        };
        window.addTaskRow = () => {
            const div = document.createElement('div');
            div.className = "flex flex-col sm:flex-row gap-2 task-row border-b pb-3 sm:border-0 sm:pb-0 last:border-0 mb-2 sm:mb-0";
            div.innerHTML = `<input type="text" placeholder="任務名稱" class="border rounded px-3 py-1 w-full sm:flex-1 task-name"><div class="flex gap-2"><input type="number" placeholder="罰款$" class="border rounded px-3 py-1 flex-1 sm:w-24 task-fine"><button onclick="this.closest('.task-row').remove()" class="text-red-500 px-2"><i class="fa-solid fa-xmark"></i></button></div>`;
            document.getElementById('task-inputs').appendChild(div);
        };
        window.toggleFineForm = () => {
            const content = document.getElementById('fine-form-content');
            const arrow = document.getElementById('fine-form-arrow');
            content.classList.toggle('hidden');
            arrow.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        };
        
        ['fine-start', 'fine-end'].forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                const display = document.getElementById(id + '-display-text');
                if (this.value) {
                    display.textContent = this.value.replace(/-/g, '/');
                    display.classList.remove('text-gray-400');
                    display.classList.add('text-gray-800');
                } else {
                    display.textContent = id === 'fine-start' ? '開始日期' : '結束日期';
                     display.classList.add('text-gray-400');
                     display.classList.remove('text-gray-800');
                }
            });
        });

        window.createFineEvent = async () => {
            const title = document.getElementById('fine-title').value;
            const start = document.getElementById('fine-start').value;
            const end = document.getElementById('fine-end').value;
            if(!title || !start || !end) return alert('請填寫完整資訊');

            const tasks = [];
            document.querySelectorAll('.task-row').forEach((row, idx) => {
                const name = row.querySelector('.task-name').value;
                const amt = row.querySelector('.task-fine').value;
                if(name && amt) tasks.push({id: 't'+idx, name, amount: parseInt(amt)});
            });
            
            const participants = [];
            document.querySelectorAll('.fine-user-check:checked').forEach(cb => {
                participants.push({uid: cb.value, name: cb.nextElementSibling.textContent});
            });

            if(!tasks.length || !participants.length) return alert('至少需有一個任務與一位參加者');

            await addDoc(getColRef('fine_events'), {
                title, startDate: start, endDate: end, tasks, participants,
                createdAt: serverTimestamp()
            });
            alert('建立成功');
            
            document.getElementById('fine-title').value = '';
            document.getElementById('fine-start').value = '';
            document.getElementById('fine-end').value = '';
            document.getElementById('fine-start-display-text').textContent = '開始日期';
            document.getElementById('fine-start-display-text').classList.add('text-gray-400');
             document.getElementById('fine-end-display-text').textContent = '結束日期';
            document.getElementById('fine-end-display-text').classList.add('text-gray-400');
            
            const taskContainer = document.getElementById('task-inputs');
            taskContainer.innerHTML = '';
             window.addTaskRow(); 
             document.querySelectorAll('.fine-user-check').forEach(cb => cb.checked = false);
             window.toggleFineForm();
        };

        window.loadFineDashboard = function() {
            document.getElementById('fine-dashboard-view').classList.remove('hidden');
            document.getElementById('fine-detail-view').classList.add('hidden');
            if(unsubFineRecords) unsubFineRecords();
            const q = query(getColRef('fine_events'), orderBy('createdAt', 'desc'));
            unsubFineEvents = onSnapshot(q, (snap) => {
                const list = document.getElementById('fine-events-list');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const delBtn = isAdmin ? `<button onclick="window.delFineEvent('${doc.id}', event)" class="text-gray-400 hover:text-red-500 ml-2"><i class="fa-solid fa-trash"></i></button>` : '';
                    list.innerHTML += `<div onclick="loadFineDetail('${doc.id}')" class="bg-white p-5 rounded-xl shadow cursor-pointer border-l-4 border-red-500 flex justify-between items-center hover:bg-red-50"><div><h3 class="font-bold text-lg text-gray-800">${d.title}</h3><p class="text-xs text-gray-500">${d.startDate} ~ ${d.endDate}</p></div>${delBtn}</div>`;
                });
            });
        }
        window.delFineEvent = async (id, e) => {
            e.stopPropagation();
            if(confirm('刪除此活動?')) await deleteDoc(getDocRef('fine_events', id));
        };
        window.loadFineDetail = async (id) => {
            const docSnap = await getDoc(getDocRef('fine_events', id));
            if (!docSnap.exists()) return;
            currentFineEvent = {id, ...docSnap.data()};
            document.getElementById('fine-dashboard-view').classList.add('hidden');
            document.getElementById('fine-detail-view').classList.remove('hidden');
            document.getElementById('fd-title').textContent = currentFineEvent.title;
            document.getElementById('fd-dates').textContent = `${currentFineEvent.startDate} ~ ${currentFineEvent.endDate}`;
            renderDailyCheck();
            calculateAndRenderStats();
        };

        function renderDailyCheck() {
            const area = document.getElementById('daily-check-area');
            const todayStr = getLocalTodayStr();
            document.getElementById('today-date-str').textContent = todayStr;
            
            if (todayStr < currentFineEvent.startDate || todayStr > currentFineEvent.endDate) {
                area.innerHTML = '<p class="text-gray-500">非活動期間</p>';
                return;
            }

            const me = currentFineEvent.participants.find(p => p.uid === currentUser.uid);
            if (!me) {
                area.innerHTML = '<p class="text-gray-500">您不是此活動的參加者</p>';
                return;
            }

            const recordId = `${currentFineEvent.id}_${todayStr}_${currentUser.uid}`;
            const ref = getDocRef('fine_records', recordId);
            
            onSnapshot(ref, (snap) => {
                const data = snap.exists() ? snap.data() : { completed: [] };
                let html = '';
                currentFineEvent.tasks.forEach(t => {
                    const checked = data.completed && data.completed.includes(t.id) ? 'checked' : '';
                    html += `
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-green-50 transition-colors">
                            <input type="checkbox" onchange="window.toggleTask('${recordId}', '${t.id}', this.checked)" class="form-checkbox h-5 w-5 text-green-600 rounded" ${checked}>
                            <span class="ml-3 font-medium text-gray-700">${t.name}</span>
                        </label>
                    `;
                });
                area.innerHTML = html;
            });
        }

        window.toggleTask = async (recId, taskId, isDone) => {
            const ref = getDocRef('fine_records', recId);
            const snap = await getDoc(ref);
            if (!snap.exists()) {
                if (isDone) await setDoc(ref, { completed: [taskId] });
            } else {
                if (isDone) await updateDoc(ref, { completed: arrayUnion(taskId) });
                else await updateDoc(ref, { completed: arrayRemove(taskId) });
            }
        };

        async function calculateAndRenderStats() {
            const q = query(getColRef('fine_records'), 
                where('__name__', '>=', `${currentFineEvent.id}_`), 
                where('__name__', '<=', `${currentFineEvent.id}_\uf8ff`));
            
            const snap = await getDocs(q);
            const recordsMap = {}; 
            snap.forEach(d => {
                const parts = d.id.split('_'); 
                const uid = parts.slice(2).join('_');
                const date = parts[1];
                if(!recordsMap[uid]) recordsMap[uid] = {};
                recordsMap[uid][date] = d.data().completed || [];
            });

            const dates = [];
            let curr = new Date(currentFineEvent.startDate);
            const end = new Date(currentFineEvent.endDate);
            // Fix: Use local today at 00:00 for comparison
            const now = new Date();
            const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
            const today = new Date(todayStr);

            const calcEnd = end < today ? end : today; 
            
            for(let d = new Date(curr); d <= calcEnd; d.setDate(d.getDate()+1)) {
                dates.push(d.toISOString().split('T')[0]);
            }

            const thead = document.getElementById('stats-header');
            let headerHTML = '<th class="px-4 py-3 bg-gray-50 whitespace-nowrap">姓名</th>';
            currentFineEvent.tasks.forEach(t => {
                headerHTML += `<th class="px-4 py-3 text-center bg-gray-50 text-red-600 whitespace-nowrap">${t.name}<br><span class="text-xs">未完成</span></th>`;
            });
            headerHTML += '<th class="px-4 py-3 text-right bg-gray-50 font-bold whitespace-nowrap">總罰金</th>';
            thead.innerHTML = headerHTML;

            const tbody = document.getElementById('stats-body');
            tbody.innerHTML = '';
            
            currentFineEvent.participants.forEach(p => {
                const userRecs = recordsMap[p.uid] || {};
                let rowHTML = `<td class="px-4 py-3 font-medium text-gray-900 border-b whitespace-nowrap">${p.name}</td>`;
                let totalFine = 0;

                currentFineEvent.tasks.forEach(t => {
                    let missCount = 0;
                    dates.forEach(date => {
                        const done = userRecs[date] && userRecs[date].includes(t.id);
                        if (!done) missCount++;
                    });
                    const fine = missCount * t.amount;
                    totalFine += fine;
                    rowHTML += `<td class="px-4 py-3 text-center border-b text-gray-600 whitespace-nowrap">${missCount} <span class="text-xs text-gray-400">($${fine})</span></td>`;
                });
                
                rowHTML += `<td class="px-4 py-3 text-right border-b font-bold text-red-600 whitespace-nowrap">$${totalFine}</td>`;
                tbody.innerHTML += `<tr>${rowHTML}</tr>`;
            });
        }

        // --- LESSON APP LOGIC ---
        let lessonSelectedUid = null;
        let lessonSelectedDate = null;
        let currentLessonList = [];
        let lessonPage = 1;
        const LESSON_PER_PAGE = 12;
        
        function initLessonApp() {
            document.getElementById('main-menu-container').classList.add('hidden');
            document.getElementById('lesson-app-container').classList.remove('hidden');
            
            cleanupOldLessons();

            const userSelect = document.getElementById('lesson-user-select');
            userSelect.innerHTML = '<option>載入中...</option>';
            getDocs(getColRef('users')).then(snap => {
                userSelect.innerHTML = '';
                let hasMe = false;
                snap.forEach(doc => {
                    const u = doc.data();
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.textContent = u.name;
                    if(doc.id === currentUser.uid) { 
                        opt.selected = true; 
                        hasMe = true;
                    }
                    userSelect.appendChild(opt);
                });
                if(!hasMe) { 
                    const opt = document.createElement('option');
                    opt.value = currentUser.uid;
                    opt.textContent = displayName;
                    opt.selected = true;
                    userSelect.appendChild(opt);
                }
                
                lessonSelectedUid = userSelect.value;
                showLessonListView();
            });
            
            userSelect.onchange = () => {
                lessonSelectedUid = userSelect.value;
                showLessonListView();
            };
        }

        function showLessonListView() {
            document.getElementById('lesson-list-view').classList.remove('hidden');
            document.getElementById('lesson-form-view').classList.add('hidden');
            
            const addBtn = document.getElementById('lesson-add-btn');
            if(addBtn) {
                if (lessonSelectedUid === currentUser.uid) {
                    addBtn.classList.remove('hidden');
                } else {
                    addBtn.classList.add('hidden');
                }
            }

            loadLessonHistoryList(lessonSelectedUid);
        }

        window.openLessonForm = (date = null) => {
            const d = date || getLocalTodayStr(); // Fix: use local date
            lessonSelectedDate = d;
            
            document.getElementById('lesson-list-view').classList.add('hidden');
            document.getElementById('lesson-form-view').classList.remove('hidden');
            
            // Update Title (Fixed: don't target deleted ID)
            const formDateDisplay = document.getElementById('lesson-form-date-display');
            if(formDateDisplay) {
                formDateDisplay.textContent = d.replace(/-/g, '/');
                formDateDisplay.classList.remove('text-gray-800'); // Remove default style
                formDateDisplay.classList.add('text-teal-700'); // Add active style
            }
            
            // Reset Date Picker text in Form
            const formDateInput = document.getElementById('lesson-form-date');
            if(formDateInput) {
                formDateInput.value = d;
            }
            
            // If viewing other's record (via clicking card), disable editing
            // But openLessonForm is called by clicking card OR add button.
            // If add button -> lessonSelectedUid is me.
            // If clicking card -> lessonSelectedUid could be others.
            
            const saveBtn = document.getElementById('save-lesson-btn');
            const overlay = document.getElementById('lesson-overlay');
            const datePickerDiv = document.querySelector('#lesson-form-date').parentNode; // The relative wrapper
            
            if (lessonSelectedUid !== currentUser.uid) {
                overlay.classList.remove('hidden'); // Read-only overlay on inputs
                saveBtn.classList.add('hidden');
                // Disable date picker interaction
                datePickerDiv.style.pointerEvents = 'none';
            } else {
                overlay.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                datePickerDiv.style.pointerEvents = 'auto';
            }

            window.loadLessonData();
        };

        window.closeLessonForm = () => {
            document.getElementById('lesson-form-view').classList.add('hidden');
            document.getElementById('lesson-list-view').classList.remove('hidden');
            loadLessonHistoryList(lessonSelectedUid); // Refresh list
        };

        window.loadLessonData = async () => {
            const msg = document.getElementById('lesson-msg');
            msg.textContent = '讀取中...';
            
            // Reset UI
            document.querySelectorAll('.l-input').forEach(i => i.value = '');
            
            const docId = `${lessonSelectedUid}_${lessonSelectedDate}`;
            const ref = getDocRef('daily_lessons', docId);
            
            try {
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    const data = snap.data();
                    const inputs = document.querySelectorAll('#gratitude-inputs input');
                    if(data.gratitudes) data.gratitudes.forEach((txt, i) => { if(inputs[i]) inputs[i].value = txt; });
                    document.getElementById('carebook-input').value = data.careBook || '';
                    document.getElementById('todo-input').value = data.todo || '';
                    msg.textContent = '';
                } else {
                    msg.textContent = '無資料';
                }
            } catch (e) {
                console.error(e);
                msg.textContent = '讀取錯誤';
            }
        };

        window.saveLesson = async () => {
            const btn = document.getElementById('save-lesson-btn');
            btn.disabled = true;
            btn.textContent = '儲存中...';
            
            const gratitudes = [];
            document.querySelectorAll('#gratitude-inputs input').forEach(i => gratitudes.push(i.value));
            const careBook = document.getElementById('carebook-input').value;
            const todo = document.getElementById('todo-input').value;
            
            const docId = `${currentUser.uid}_${lessonSelectedDate}`;
            
            try {
                await setDoc(getDocRef('daily_lessons', docId), {
                    uid: currentUser.uid,
                    date: lessonSelectedDate,
                    creatorName: displayName,
                    gratitudes,
                    careBook,
                    todo,
                    createdAt: serverTimestamp()
                });
                document.getElementById('lesson-msg').textContent = '已儲存!';
            } catch (e) {
                alert('儲存失敗: ' + e.message);
            }
            btn.disabled = false;
            btn.textContent = '儲存';
        };

        async function cleanupOldLessons() {
            const d = new Date();
            d.setDate(d.getDate() - 60);
            const dateStr = d.toISOString().split('T')[0];
            const q = query(getColRef('daily_lessons'), where('uid', '==', currentUser.uid));
            const snap = await getDocs(q);
            if(!snap.empty) {
                const batch = writeBatch(db);
                let count = 0;
                snap.forEach(doc => {
                    const data = doc.data();
                    if(data.date < dateStr) {
                         batch.delete(doc.ref);
                         count++;
                    }
                });
                if(count > 0) {
                    await batch.commit();
                    console.log('Cleaned up old lessons');
                }
            }
        }
        
        async function loadLessonHistoryList(uid) {
            const listContainer = document.getElementById('lesson-history-list');
            listContainer.innerHTML = '<p class="text-gray-400 text-sm col-span-full">載入中...</p>';
            
            const q = query(getColRef('daily_lessons'), where('uid', '==', uid));
            try {
                const snap = await getDocs(q);
                if(snap.empty) {
                    listContainer.innerHTML = '<p class="text-gray-400 text-sm col-span-full">尚無紀錄</p>';
                    document.getElementById('lesson-pagination').innerHTML = '';
                    return;
                }
                
                // Client-side sort
                const docs = [];
                snap.forEach(doc => docs.push({ id: doc.id, ...doc.data() }));
                docs.sort((a, b) => b.date.localeCompare(a.date));
                
                currentLessonList = docs;
                renderLessonPage(1);

            } catch(e) { console.error(e); }
        }

        window.renderLessonPage = (page) => {
            lessonPage = page;
            const start = (page - 1) * LESSON_PER_PAGE;
            const end = start + LESSON_PER_PAGE;
            const pageItems = currentLessonList.slice(start, end);
            
            const listContainer = document.getElementById('lesson-history-list');
            listContainer.innerHTML = '';
            
            pageItems.forEach(d => {
                const gPreview = d.gratitudes.filter(t=>t).length;
                const cbPreview = d.careBook ? '有' : '無';
                const todoPreview = d.todo ? '有' : '無';

                listContainer.innerHTML += `
                    <div class="lesson-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer relative hover:border-teal-500" onclick="window.openLessonForm('${d.date}')">
                        <div class="flex justify-between items-center mb-2">
                             <h4 class="font-bold text-teal-700">${d.date}</h4>
                             <input type="checkbox" value="${d.id}" class="lesson-export-check form-checkbox text-teal-600 rounded" onclick="event.stopPropagation()">
                        </div>
                        <div class="text-xs text-gray-500 space-y-1">
                             <p><i class="fa-solid fa-heart text-pink-400 mr-1"></i>感恩: ${gPreview} 則</p>
                             <p><i class="fa-solid fa-book-open text-blue-400 mr-1"></i>關心書: ${cbPreview}</p>
                             <p><i class="fa-solid fa-list-check text-green-500 mr-1"></i>Todo: ${todoPreview}</p>
                        </div>
                    </div>
                `;
            });
            
            const totalPages = Math.ceil(currentLessonList.length / LESSON_PER_PAGE);
            const pagContainer = document.getElementById('lesson-pagination');
            pagContainer.innerHTML = '';
            if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    btn.className = `px-3 py-1 rounded text-sm ${i === page ? 'bg-teal-600 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`;
                    btn.onclick = () => window.renderLessonPage(i);
                    pagContainer.appendChild(btn);
                }
            }
        };
        
        window.toggleAllLessons = (checked) => {
            document.querySelectorAll('.lesson-export-check').forEach(c => c.checked = checked);
        };
        
        window.exportSelectedLessons = async () => {
            const checked = document.querySelectorAll('.lesson-export-check:checked');
            if(checked.length === 0) return alert('請選擇日期');
            
            const container = document.getElementById('export-canvas-container');
            container.innerHTML = ''; 
            
            for(const box of checked) {
                const docId = box.value;
                const snap = await getDoc(getDocRef('daily_lessons', docId));
                if(!snap.exists()) continue;
                const d = snap.data();
                
                const card = document.createElement('div');
                card.className = 'lesson-export-card';
                card.innerHTML = `
                    <h1 style="color:#0f766e; font-size:24px; font-weight:bold; margin-bottom:10px; border-bottom: 2px solid #0f766e; padding-bottom:10px;">${d.date} 每日定課 - ${d.creatorName}</h1>
                    <div style="margin-bottom:20px;">
                        <h3 style="color:#0f766e; font-size:18px; margin-bottom:5px;">每日五感恩</h3>
                        <ul style="list-style:none; padding:0;">
                            ${d.gratitudes.map((t,i) => `<li style="margin-bottom:5px; font-size:16px;">${i+1}. ${t || '...'}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="margin-bottom:20px;">
                        <h3 style="color:#0f766e; font-size:18px; margin-bottom:5px;">關心書</h3>
                        <p style="white-space:pre-wrap; font-size:16px; line-height:1.5;">${d.careBook || '無'}</p>
                    </div>
                    <div>
                        <h3 style="color:#0f766e; font-size:18px; margin-bottom:5px;">To-do</h3>
                        <p style="white-space:pre-wrap; font-size:16px; line-height:1.5;">${d.todo || '無'}</p>
                    </div>
                `;
                container.appendChild(card);
                
                try {
                    const canvas = await html2canvas(card);
                    const link = document.createElement('a');
                    link.download = `${d.creatorName}_每日定課_${d.date}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg');
                    link.click();
                } catch(err) { console.error('Export fail', err); }
            }
            container.innerHTML = ''; 
        };
    </script>
</body>
</html>
