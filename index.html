<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人活動投票平台 (資安強化版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .vote-card { transition: all 0.3s ease; }
        .vote-card:hover { transform: translateY(-2px); }
        .event-card { transition: all 0.2s ease; }
        .event-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        #welcome-modal { background-image: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        
        /* 開關樣式 */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4F46E5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4F46E5;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800 font-sans">

    <!-- 1. 登入/角色選擇畫面 -->
    <div id="welcome-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center relative transition-all duration-300">
            <div class="mb-6 text-gray-800">
                <i class="fa-solid fa-users-gear text-5xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">身分驗證</h2>
            <p class="text-gray-500 mb-6 text-sm">請選擇您的登入身分</p>
            
            <!-- Step 0: 角色選擇 -->
            <div id="role-select-step" class="space-y-3">
                <!-- 管理員改為藍色 -->
                <button onclick="selectRole('admin')" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-shield-halved"></i> 管理員
                </button>
                <!-- 成員改為黑色 -->
                <button onclick="selectRole('member')" class="w-full bg-gray-900 hover:bg-black text-white font-bold py-3 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-user-check"></i> 成員
                </button>
                <button onclick="selectRole('guest')" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-eye"></i> 訪客
                </button>
            </div>

            <!-- Step 1: 輸入資料 (共用介面) -->
            <div id="login-input-step" class="space-y-4 hidden">
                <div id="role-badge" class="inline-block px-3 py-1 rounded-full text-xs font-bold mb-2"></div>
                
                <input type="text" id="login-name-input" placeholder="請輸入暱稱" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-800 focus:outline-none text-center text-lg">
                
                <!-- 密碼欄位 (訪客不顯示) -->
                <input type="password" id="login-pwd-input" placeholder="請輸入密碼" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-800 focus:outline-none text-center text-lg hidden">
                
                <div class="flex gap-2">
                    <button onclick="resetLogin()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg">返回</button>
                    <button id="login-submit-btn" class="flex-1 bg-blue-800 hover:bg-blue-900 text-white font-bold py-3 rounded-lg shadow-lg">進入</button>
                </div>
            </div>
            
            <p id="login-msg" class="mt-4 text-xs text-red-500 min-h-[1rem]"></p>
        </div>
    </div>

    <!-- 2. 主程式 (Dashboard + Voting) -->
    <div id="app-container" class="hidden min-h-screen pb-10">
        
        <!-- Navbar -->
        <header id="main-header" class="bg-gray-800 text-white shadow-lg sticky top-0 z-10 transition-colors duration-300">
            <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold flex items-center gap-2">
                        <i id="header-icon" class="fa-solid fa-users"></i>
                        <span id="header-title">活動大廳</span>
                    </h1>
                    <div class="flex items-center text-gray-300 text-xs mt-1 gap-2">
                        <span id="user-display"></span>
                        <button id="logout-btn" class="underline hover:text-white bg-white/10 px-2 py-0.5 rounded ml-2">登出</button>
                    </div>
                </div>
                <button id="back-btn" class="hidden text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors">
                    <i class="fa-solid fa-chevron-left mr-1"></i> 回列表
                </button>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-6">
            
            <!-- 設定與權限警告 -->
            <div id="config-warning" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 hidden">
                <p class="font-bold">設定尚未完成</p>
                <p>請填入 Firebase Config。</p>
            </div>
            <div id="permission-warning" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 hidden">
                <p class="font-bold"><i class="fa-solid fa-ban"></i> 權限不足或規則錯誤</p>
                <p class="text-sm">操作被拒絕。請確認您的權限，或檢查 Firestore Rules。</p>
            </div>

            <!-- VIEW: Dashboard -->
            <div id="dashboard-view">
                
                <!-- 柱專用：系統設定區塊 -->
                <div id="super-admin-settings" class="bg-white rounded-xl shadow-md p-4 mb-6 border border-indigo-200 hidden">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <i class="fa-solid fa-gears text-indigo-600 text-xl mr-3"></i>
                            <div>
                                <h3 class="font-bold text-gray-800">系統管理 (柱專用)</h3>
                                <p class="text-xs text-gray-500">控制成員註冊權限</p>
                            </div>
                        </div>
                        
                        <!-- Toggle Switch -->
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="reg-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                            <label for="reg-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <p id="reg-status-text" class="text-right text-xs mt-1 text-gray-500">讀取中...</p>
                </div>

                <!-- 發起活動 (管理員 + 成員 可見) -->
                <div id="create-event-section" class="bg-white rounded-xl shadow-md p-6 mb-8 border-l-4 hidden">
                    <h2 class="text-lg font-semibold mb-4 text-gray-700">發起新活動</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <input type="text" id="new-event-title" placeholder="活動主題..." class="flex-1 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                        <button id="create-event-btn" class="bg-gray-800 hover:bg-gray-900 text-white px-6 py-2 rounded-lg font-bold whitespace-nowrap transition-colors">建立</button>
                    </div>
                </div>

                <div class="mb-4 flex justify-between items-end">
                    <h2 class="text-xl font-bold text-gray-800">活動列表</h2>
                    <span class="text-sm text-gray-500">最新 20 筆</span>
                </div>
                
                <div id="events-loader" class="flex justify-center py-10"><div class="loader"></div></div>
                <div id="events-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <div id="no-events-msg" class="hidden text-center py-12 text-gray-400 border border-dashed rounded-xl">目前沒有活動</div>
            </div>

            <!-- VIEW: Voting -->
            <div id="voting-view" class="hidden">
                <h2 id="current-event-title" class="text-2xl font-bold mb-4 text-gray-800"></h2>

                <!-- 新增選項 (共用區塊：管理員與成員共用) -->
                <div id="create-vote-section" class="bg-white rounded-xl shadow-md p-4 mb-6 border hidden">
                    <div class="flex items-center mb-2 text-gray-800 text-sm font-bold" id="cv-header-text">
                        <i class="fa-solid fa-pen-to-square mr-1"></i> 新增選項
                    </div>
                    <div class="flex flex-col md:flex-row gap-2">
                        <!-- 自定義日期選擇器 -->
                        <!-- 修正：外層 div 加入 onclick 觸發 showPicker，input 設為 pointer-events-none -->
                        <div class="relative flex-1 group cursor-pointer" onclick="try{document.getElementById('new-vote-date').showPicker()}catch(e){document.getElementById('new-vote-date').focus()}">
                            <!-- 隱藏的原生 Input -->
                            <input type="date" id="new-vote-date" class="absolute inset-0 w-full h-full opacity-0 pointer-events-none" tabindex="-1">
                            <!-- 顯示用的 Div -->
                            <div id="date-display-box" class="w-full border rounded-lg px-3 py-2 bg-white flex justify-between items-center h-[42px] transition-colors border-gray-300">
                                <span id="date-display-text" class="text-gray-400 text-sm select-none">年/月/日</span>
                                <i class="fa-regular fa-calendar text-gray-500"></i>
                            </div>
                        </div>
                        
                        <input type="text" id="new-vote-note" placeholder="備註 (例: 午餐)" class="flex-1 border rounded-lg px-3 py-2 outline-none focus:ring-1 focus:ring-blue-500">
                        <button id="add-vote-btn" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg font-bold whitespace-nowrap transition-colors">新增</button>
                    </div>
                </div>

                <!-- 訪客唯讀提示 -->
                <div id="guest-hint" class="bg-gray-100 text-gray-600 p-3 rounded-lg mb-6 text-center text-sm border border-gray-200 hidden">
                    <i class="fa-solid fa-eye mr-1"></i> 您目前處於訪客模式，僅供瀏覽投票結果
                </div>

                <div id="voting-loader" class="flex justify-center py-10 hidden"><div class="loader"></div></div>
                <div id="vote-list" class="space-y-3"></div>
                <div id="voting-empty-msg" class="hidden text-center py-10 text-gray-400">尚無選項</div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, onSnapshot, serverTimestamp, query, orderBy, where, limit, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        //  ⚠️ 設定區域：請填入您的 Firebase Config
        // ==========================================
        let firebaseConfig;
        try { if (typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config); } catch (e) {}

        if (!firebaseConfig) {
            firebaseConfig = {
                // ⚠️ 請替換成您的設定 ⚠️
                apiKey: "AIzaSyDQiHjNozV07Q8y6XtqGSAMcCnOEaGhPqM",
  				authDomain: "vote-7e8d0.firebaseapp.com",
  				projectId: "vote-7e8d0",
  				storageBucket: "vote-7e8d0.firebasestorage.app",
  				messagingSenderId: "218847236466",
  				appId: "1:218847236466:web:d1904b9ec032ac35a7cdeb",
  				measurementId: "G-HKJ9QSFB5L"
            };
        }

        // --- Init ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        const ADMIN_LIST = ['ELLY LIN', 'Ling', 'Luna', '柱'];
        const SUPER_ADMIN = '柱';
        
        let currentUser = null;
        let isAdmin = false;
        let isMember = false;
        let selectedRole = null; 
        
        let currentEventId = null;
        let unsubEvents = null;
        let unsubVotes = null;

        // --- DOM Elements ---
        const roleSelectStep = document.getElementById('role-select-step');
        const loginInputStep = document.getElementById('login-input-step');
        const roleBadge = document.getElementById('role-badge');
        const loginNameInput = document.getElementById('login-name-input');
        const loginPwdInput = document.getElementById('login-pwd-input');
        const loginMsg = document.getElementById('login-msg');
        
        const superAdminSettings = document.getElementById('super-admin-settings');
        const regToggle = document.getElementById('reg-toggle');
        const regStatusText = document.getElementById('reg-status-text');
        
        // Date Picker Elements
        const newVoteDateInput = document.getElementById('new-vote-date');
        const dateDisplayText = document.getElementById('date-display-text');

        // 1. 初始化檢查
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                checkUserPermissions(user);
                showAppUI();
            } else {
                showLoginUI();
            }
        });

        // 2. 日期選擇器邏輯 (Custom Date Picker)
        newVoteDateInput.addEventListener('change', function() {
            if (this.value) {
                // 將 yyyy-mm-dd 轉為 yyyy/mm/dd
                const formattedDate = this.value.replace(/-/g, '/');
                dateDisplayText.textContent = formattedDate;
                dateDisplayText.classList.remove('text-gray-400');
                dateDisplayText.classList.add('text-gray-800');
            } else {
                dateDisplayText.textContent = '年/月/日';
                dateDisplayText.classList.add('text-gray-400');
                dateDisplayText.classList.remove('text-gray-800');
            }
        });

        function checkUserPermissions(user) {
            const email = user.email || '';
            isAdmin = email.endsWith('@admin.com');
            isMember = email.endsWith('@member.com');
        }

        // --- 登入 UI ---
        
        window.selectRole = (role) => {
            selectedRole = role;
            roleSelectStep.classList.add('hidden');
            loginInputStep.classList.remove('hidden');
            
            loginNameInput.value = '';
            loginPwdInput.value = '';
            loginMsg.textContent = '';
            
            if (role === 'admin') {
                roleBadge.textContent = '管理員登入';
                roleBadge.className = 'inline-block px-3 py-1 rounded-full text-xs font-bold mb-2 bg-blue-100 text-blue-800';
                loginPwdInput.classList.remove('hidden');
            } else if (role === 'member') {
                roleBadge.textContent = '成員登入';
                roleBadge.className = 'inline-block px-3 py-1 rounded-full text-xs font-bold mb-2 bg-gray-200 text-gray-900';
                loginPwdInput.classList.remove('hidden');
            } else {
                roleBadge.textContent = '訪客預覽';
                roleBadge.className = 'inline-block px-3 py-1 rounded-full text-xs font-bold mb-2 bg-gray-200 text-gray-500';
                loginPwdInput.classList.add('hidden');
            }
        };

        window.resetLogin = () => {
            loginInputStep.classList.add('hidden');
            roleSelectStep.classList.remove('hidden');
            selectedRole = null;
        };

        document.getElementById('login-submit-btn').onclick = () => {
            const name = loginNameInput.value.trim();
            if (!name) return;
            
            if (selectedRole === 'guest') {
                performGuestLogin(name);
            } else {
                const pwd = loginPwdInput.value;
                if (!pwd) {
                    loginMsg.textContent = '請輸入密碼';
                    return;
                }
                
                if (selectedRole === 'admin') {
                    const matchedAdmin = ADMIN_LIST.find(a => a.toLowerCase() === name.toLowerCase());
                    if (!matchedAdmin) {
                        loginMsg.textContent = '此名稱非管理員';
                        return;
                    }
                    performAuthLogin(matchedAdmin, pwd, 'admin.com');
                } else if (selectedRole === 'member') {
                    performAuthLogin(name, pwd, 'member.com');
                }
            }
        };

        async function performGuestLogin(name) {
            loginMsg.textContent = '登入中...';
            try {
                sessionStorage.setItem('display_name', name);
                await signInAnonymously(auth);
            } catch (error) {
                sessionStorage.removeItem('display_name');
                loginMsg.textContent = '登入失敗: ' + error.message;
            }
        }

        async function performAuthLogin(name, pwd, domain) {
            loginMsg.textContent = '驗證中...';
            const email = name.toLowerCase().replace(/\s+/g, '_') + '@' + domain;
            
            try {
                await signInWithEmailAndPassword(auth, email, pwd);
                sessionStorage.setItem('display_name', name); 
            } catch (error) {
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    if (domain === 'member.com') {
                        try {
                            const isOpen = await checkRegistrationOpen();
                            if (!isOpen) {
                                loginMsg.textContent = '目前暫停開放新成員註冊';
                                return;
                            }
                        } catch (checkErr) {
                            console.error(checkErr);
                        }
                    }

                    try {
                        await createUserWithEmailAndPassword(auth, email, pwd);
                        sessionStorage.setItem('display_name', name);
                    } catch (regError) {
                        if (regError.code === 'auth/email-already-in-use') {
                             loginMsg.textContent = '登入失敗: 密碼錯誤';
                        } else {
                             loginMsg.textContent = '註冊失敗: ' + regError.message;
                        }
                    }
                } else {
                    loginMsg.textContent = '登入失敗: ' + error.message;
                }
            }
        }

        document.getElementById('logout-btn').onclick = () => {
            if(confirm('確定要登出嗎？')) {
                sessionStorage.removeItem('display_name');
                signOut(auth);
            }
        };

        // --- Settings Logic (Moved Before usage in showAppUI) ---
        function getSettingsDocRef() {
            const appIdStr = (typeof __app_id !== 'undefined') ? __app_id : 'default';
            if (typeof __app_id !== 'undefined') {
                return doc(db, 'artifacts', appIdStr, 'public', 'data', 'events', 'system_settings');
            } else {
                return doc(db, 'events', 'system_settings');
            }
        }

        async function checkRegistrationOpen() {
            try {
                const docSnap = await getDoc(getSettingsDocRef());
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    return data.memberRegistrationOpen !== false; 
                }
                return true; 
            } catch (e) {
                console.error("Check setting failed:", e);
                return true; 
            }
        }

        async function initSettingsToggle() {
            regStatusText.textContent = "讀取中...";
            try {
                const docRef = getSettingsDocRef();
                const docSnap = await getDoc(docRef);
                let isOpen = true;
                if (docSnap.exists()) {
                    isOpen = docSnap.data().memberRegistrationOpen !== false;
                }
                regToggle.checked = isOpen;
                updateStatusText(isOpen);
                
                regToggle.onchange = async () => {
                    const newState = regToggle.checked;
                    updateStatusText(newState);
                    await setDoc(docRef, { memberRegistrationOpen: newState }, { merge: true });
                };
            } catch (e) {
                console.error("Setting init failed", e);
                regStatusText.textContent = "設定讀取失敗";
            }
        }

        function updateStatusText(isOpen) {
            regStatusText.textContent = isOpen ? "成員註冊：已開放" : "成員註冊：已關閉";
            regStatusText.className = isOpen ? "text-right text-xs mt-1 text-green-600 font-bold" : "text-right text-xs mt-1 text-red-500 font-bold";
        }

        // --- UI Update Logic ---

        function showLoginUI() {
            if (unsubEvents) { unsubEvents(); unsubEvents = null; }
            if (unsubVotes) { unsubVotes(); unsubVotes = null; }
            
            document.getElementById('welcome-modal').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
            
            window.resetLogin();
        }

        async function showAppUI() {
            document.getElementById('welcome-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            let displayName = sessionStorage.getItem('display_name');
            if (!displayName && currentUser.email) {
                displayName = currentUser.email.split('@')[0].replace('_', ' ').toUpperCase();
            }
            if (!displayName) displayName = 'Guest';
            
            let roleText = '訪客';
            if (isAdmin) roleText = '管理員';
            else if (isMember) roleText = '成員';
            
            document.getElementById('user-display').textContent = `${roleText}: ${displayName}`;
            
            const header = document.getElementById('main-header');
            const createEventSection = document.getElementById('create-event-section');
            const createVoteSection = document.getElementById('create-vote-section'); // 共用區塊
            const guestHint = document.getElementById('guest-hint');
            const createEventBtn = document.getElementById('create-event-btn');
            const addVoteBtn = document.getElementById('add-vote-btn');
            const cvHeaderText = document.getElementById('cv-header-text');
            const dateDisplayBox = document.getElementById('date-display-box');

            if (isAdmin) {
                // 管理員：藍色系
                header.classList.remove('bg-gray-800', 'bg-yellow-700');
                header.classList.add('bg-blue-700');
                
                createEventBtn.className = "bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold whitespace-nowrap transition-colors";
                addVoteBtn.className = "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold whitespace-nowrap transition-colors";
                
                // 動態設定樣式 (合併後的區塊)
                createEventSection.classList.remove('hidden');
                createVoteSection.classList.remove('hidden');
                
                createEventSection.classList.remove('border-gray-800');
                createEventSection.classList.add('border-blue-500');
                
                createVoteSection.classList.remove('border-gray-800');
                createVoteSection.classList.add('border-blue-200');
                if (cvHeaderText) cvHeaderText.className = "flex items-center mb-2 text-blue-800 text-sm font-bold";
                if (dateDisplayBox) dateDisplayBox.className = "w-full border rounded-lg px-3 py-2 bg-white flex justify-between items-center h-[42px] transition-colors border-gray-300"; // 預設邊框
                
                guestHint.classList.add('hidden');

                if (displayName === SUPER_ADMIN) {
                    superAdminSettings.classList.remove('hidden');
                    initSettingsToggle();
                } else {
                    superAdminSettings.classList.add('hidden');
                }

            } else if (isMember) {
                // 成員：黑色系
                header.classList.remove('bg-blue-700', 'bg-yellow-700');
                header.classList.add('bg-gray-900');
                
                createEventBtn.className = "bg-gray-800 hover:bg-black text-white px-6 py-2 rounded-lg font-bold whitespace-nowrap transition-colors";
                addVoteBtn.className = "bg-gray-800 hover:bg-black text-white px-4 py-2 rounded-lg font-bold whitespace-nowrap transition-colors";

                createEventSection.classList.remove('hidden');
                createVoteSection.classList.remove('hidden');
                
                createEventSection.classList.remove('border-blue-500');
                createEventSection.classList.add('border-gray-800'); 
                
                createVoteSection.classList.remove('border-blue-200');
                createVoteSection.classList.add('border-gray-800');
                if (cvHeaderText) cvHeaderText.className = "flex items-center mb-2 text-gray-900 text-sm font-bold";
                if (dateDisplayBox) dateDisplayBox.className = "w-full border rounded-lg px-3 py-2 bg-white flex justify-between items-center h-[42px] transition-colors border-gray-300";
                
                guestHint.classList.add('hidden');
                superAdminSettings.classList.add('hidden');

            } else {
                // 訪客：灰色系
                header.classList.remove('bg-blue-700', 'bg-gray-900');
                header.classList.add('bg-gray-600');
                
                createEventSection.classList.add('hidden');
                createVoteSection.classList.add('hidden');
                guestHint.classList.remove('hidden');
                superAdminSettings.classList.add('hidden');
            }

            loadDashboard();
        }

        // --- Dashboard Logic ---
        function loadDashboard() {
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('voting-view').classList.add('hidden');
            document.getElementById('back-btn').classList.add('hidden');
            
            if (unsubVotes) unsubVotes();
            if (!unsubEvents) subscribeEvents();
        }

        function subscribeEvents() {
            const collectionName = (typeof __app_id !== 'undefined') ? `artifacts/${__app_id}/public/data/events` : 'events';
            const q = query(collection(db, collectionName), orderBy('createdAt', 'desc'), limit(20));
            
            unsubEvents = onSnapshot(q, (snapshot) => {
                document.getElementById('events-loader').style.display = 'none';
                const list = document.getElementById('events-list');
                list.innerHTML = '';
                
                if (snapshot.empty) {
                    document.getElementById('no-events-msg').classList.remove('hidden');
                } else {
                    document.getElementById('no-events-msg').classList.add('hidden');
                    snapshot.forEach(doc => {
                        if (doc.id === 'system_settings') return;

                        const data = doc.data();
                        const date = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : '剛剛';
                        const deleteBtn = isAdmin ? `<button onclick="window.delEvent('${doc.id}', event)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 z-10 p-2"><i class="fa-solid fa-trash"></i></button>` : '';
                        
                        const div = document.createElement('div');
                        div.className = "bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-gray-50 relative group border border-gray-100 transition-all";
                        div.innerHTML = `
                            <h3 class="font-bold text-lg text-gray-800 pr-8">${data.title}</h3>
                            <p class="text-xs text-gray-500">發起人: ${data.creator || 'User'} | ${date}</p>
                            ${deleteBtn}
                        `;
                        div.onclick = () => loadVoting(doc.id, data.title);
                        list.appendChild(div);
                    });
                }
            }, handleError);
        }

        document.getElementById('create-event-btn').onclick = async function() {
            if (!isAdmin && !isMember) return alert("權限不足");
            
            const title = document.getElementById('new-event-title').value.trim();
            if (!title) return;
            
            this.disabled = true;
            try {
                const collectionName = (typeof __app_id !== 'undefined') ? `artifacts/${__app_id}/public/data/events` : 'events';
                await addDoc(collection(db, collectionName), {
                    title,
                    creator: sessionStorage.getItem('display_name') || 'User',
                    createdAt: serverTimestamp()
                });
                document.getElementById('new-event-title').value = '';
            } catch (e) { handleError(e); }
            this.disabled = false;
        };

        window.delEvent = async (id, e) => {
            e.stopPropagation();
            if (!isAdmin) return alert("僅管理員可刪除");
            if (!confirm('確定要刪除整個活動嗎？\n這將會一併刪除該活動內的所有投票資料！')) return;
            
            try {
                const eventsCol = (typeof __app_id !== 'undefined') ? `artifacts/${__app_id}/public/data/events` : 'events';
                const votesCol = (typeof __app_id !== 'undefined') ? `artifacts/${__app_id}/public/data/votes` : 'votes';
                await deleteDoc(doc(db, eventsCol, id));
                const q = query(collection(db, votesCol), where('eventId', '==', id));
                const snapshot = await getDocs(q);
                const batch = writeBatch(db);
                snapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            } catch (e) { handleError(e); }
        };

        // --- Voting Logic ---
        function loadVoting(eventId, title) {
            currentEventId = eventId;
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('voting-view').classList.remove('hidden');
            document.getElementById('back-btn').classList.remove('hidden');
            document.getElementById('current-event-title').textContent = title;
            document.getElementById('back-btn').onclick = loadDashboard;

            if (unsubVotes) unsubVotes();
            document.getElementById('voting-loader').classList.remove('hidden');
            
            const collectionName = (typeof __app_id !== 'undefined') ? `artifacts/${__app_id}/public/data/votes` : 'votes';
            const q = query(collection(db, collectionName), where('eventId', '==', eventId));
            
            unsubVotes = onSnapshot(q, (snapshot) => {
                document.getElementById('voting-loader').classList.add('hidden');
                const list = document.getElementById('vote-list');
                list.innerHTML = '';
                
                if (snapshot.empty) {
                    document.getElementById('voting-empty-msg').classList.remove('hidden');
                } else {
                    document.getElementById('voting-empty-msg').classList.add('hidden');
                    const votes = [];
                    snapshot.forEach(doc => votes.push({id: doc.id, ...doc.data()}));
                    
                    votes.sort((a,b) => (b.voters?.length || 0) - (a.voters?.length || 0));
                    const max = votes.length > 0 ? (votes[0].voters?.length || 0) : 0;

                    votes.forEach(v => {
                        const count = v.voters?.length || 0;
                        const percent = max > 0 ? (count / max) * 100 : 0;
                        const hasVoted = v.voters && v.voters.includes(currentUser.uid);
                        
                        const borderClass = hasVoted ? 'border-l-4 border-blue-500 bg-blue-50' : 'bg-white';
                        const checkIcon = hasVoted ? '<i class="fa-solid fa-check-circle text-2xl text-blue-600"></i>' : '';
                        const deleteBtn = isAdmin ? `<button onclick="window.delVote('${v.id}', event)" class="ml-2 text-red-300 hover:text-red-500 p-2 z-10"><i class="fa-solid fa-trash"></i></button>` : '';
                        
                        const canVote = isAdmin || isMember;
                        const clickAction = canVote ? `onclick="window.toggleVote('${v.id}', ${hasVoted})"` : '';
                        const cursor = canVote ? 'cursor-pointer hover:bg-gray-50' : 'cursor-default';

                        list.innerHTML += `
                            <div ${clickAction} class="relative p-4 rounded-lg shadow-sm border border-gray-100 ${borderClass} ${cursor} overflow-hidden mb-3 transition-colors">
                                <div class="absolute top-0 left-0 bottom-0 bg-blue-200 opacity-20 pointer-events-none" style="width: ${percent}%"></div>
                                <div class="relative flex justify-between items-center z-10">
                                    <div>
                                        <div class="font-bold text-lg text-gray-800">
                                            ${v.date} <span class="text-sm font-normal text-gray-500 ml-2">${v.note || ''}</span>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">${count} 人參加</div>
                                    </div>
                                    <div class="flex items-center">
                                        ${checkIcon}
                                        ${deleteBtn}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
            }, handleError);
        }

        document.getElementById('add-vote-btn').onclick = async function() {
            if (!isAdmin && !isMember) return alert("權限不足");
            
            const date = document.getElementById('new-vote-date').value;
            const note = document.getElementById('new-vote-note').value;
            if (!date) return alert('請選擇日期');
            
            this.disabled = true;
            try {
                const collectionName = (typeof __app_id !== 'undefined') ? `artifacts/${__app_id}/public/data/votes` : 'votes';
                await addDoc(collection(db, collectionName), {
                    eventId: currentEventId,
                    date,
                    note,
                    voters: []
                });
                document.getElementById('new-vote-date').value = '';
                document.getElementById('new-vote-note').value = '';
                // 重置自定義日期顯示
                dateDisplayText.textContent = '年/月/日';
                dateDisplayText.classList.add('text-gray-400');
                dateDisplayText.classList.remove('text-gray-800');
                
            } catch (e) { handleError(e); }
            this.disabled = false;
        };

        window.delVote = async (id, e) => {
            e.stopPropagation();
            if (!isAdmin) return alert("僅管理員可刪除");
            if (!confirm('刪除選項？')) return;
            try { 
                const collectionName = (typeof __app_id !== 'undefined') ? `artifacts/${__app_id}/public/data/votes` : 'votes';
                await deleteDoc(doc(db, collectionName, id)); 
            } catch (e) { handleError(e); }
        };

        window.toggleVote = async (id, hasVoted) => {
            if (!isAdmin && !isMember) return;
            try {
                const collectionName = (typeof __app_id !== 'undefined') ? `artifacts/${__app_id}/public/data/votes` : 'votes';
                const ref = doc(db, collectionName, id);
                if (hasVoted) await updateDoc(ref, { voters: arrayRemove(currentUser.uid) });
                else await updateDoc(ref, { voters: arrayUnion(currentUser.uid) });
            } catch (e) { handleError(e); }
        };

        function handleError(error) {
            console.error(error);
            if (error.code === 'permission-denied') {
                document.getElementById('permission-warning').classList.remove('hidden');
                setTimeout(() => document.getElementById('permission-warning').classList.add('hidden'), 4000);
            }
        }
    </script>
</body>
</html>
